<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <title>MongoDB Tutorial 5 - Aggregation Framework - Coding Automaton</title>
    <meta name="generator" content="Hugo 0.18.1" />

    
    <meta name="description" content="Coding made simple and automatic.">
    
    <link rel="canonical" href="http://jessezhuang.github.io/article/mongodb-aggregation-framework/">
    
    <meta name="author" content="Jesse Zhuang">
    

    <meta property="og:url" content="http://jessezhuang.github.io/article/mongodb-aggregation-framework/">
    <meta property="og:title" content="Coding Automaton">
    <meta property="og:image" content="http://jessezhuang.github.io/images/logo.jpg">
    <meta name="apple-mobile-web-app-title" content="Coding Automaton">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="http://jessezhuang.github.io/images/automata.ico">
    <link rel="icon" type="image/x-icon" href="http://jessezhuang.github.io/images/automata.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('http://jessezhuang.github.io/fonts/icon.eot?52m981');
        src: url('http://jessezhuang.github.io/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
             url('http://jessezhuang.github.io/fonts/icon.woff?52m981')
               format('woff'),
             url('http://jessezhuang.github.io/fonts/icon.ttf?52m981')
               format('truetype'),
             url('http://jessezhuang.github.io/fonts/icon.svg?52m981#icon')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="http://jessezhuang.github.io/stylesheets/application.css">
    <link rel="stylesheet" href="http://jessezhuang.github.io/stylesheets/palettes.css">
    <link rel="stylesheet" href="http://jessezhuang.github.io/stylesheets/materialize.zz.css">

    <link rel="stylesheet" href="http://jessezhuang.github.io/stylesheets/highlight/monokai-sublime.css">
    
    
    
    
    

    
    
    
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu%2bMono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="http://jessezhuang.github.io/javascripts/modernizr.js"></script>

    

    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
    
    

  </head>
  <body class="palette-primary-deep-orange palette-accent-light-blue">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        MongoDB Tutorial 5 - Aggregation Framework
      </div>
    </div>

    
    <div class="button button-twitter" role="button" aria-label="LinkeIn">
      <a href="http://jessezhuang.github.io/index.xml" title="RSS feed" target="_blank"><i class="fa fa-rss toggle-button icon" style="font-size:26px"></i></a>
    </div>
    

    
    <div class="button button-twitter" role="button" aria-label="Twitter">
       <a href="https://twitter.com/zhzexi" title="@zhzexi on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
    </div>
    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/jessezhuang" title="@jessezhuang on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    

    
    <div class="button button-twitter" role="button" aria-label="LinkeIn">
      <a href="https://linkedin.com/in/zexizhuang" title="@zexizhuang on LinkedIn" target="_blank"><i class="fa fa-linkedin toggle-button icon" style="font-size:26px"></i></a>
    </div>
    

    
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>

</header>

<main class="main">
	
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="http://jessezhuang.github.io/" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="http://jessezhuang.github.io/images/logo.jpg">
        </div>
      
      <div class="name">
        <strong>Coding Automaton </strong>
        
          <br>
          Coding made simple and automatic.
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/JesseZhuang/hugo-material-blog/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/JesseZhuang/hugo-material-blog/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Homepage" href="http://jessezhuang.github.io/">
	
	Homepage
</a>



  
</li>



<li>
  
    



<a  title="About Me" href="http://jessezhuang.github.io/page/about-me">
	
	About Me
</a>



  
</li>



<li>
  
    



<a  title="RSS feed" href="http://jessezhuang.github.io/index.xml">
	
	RSS feed
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">Categories</span>
        <span class="tags">
            
              <a href="http://jessezhuang.github.io/categories/algorithm"
                title="algorithm">
                algorithm<sup>2</sup></a>
            
              <a href="http://jessezhuang.github.io/categories/cheatsheet"
                title="cheatsheet">
                cheatsheet<sup>5</sup></a>
            
              <a href="http://jessezhuang.github.io/categories/faq"
                title="faq">
                faq<sup>1</sup></a>
            
              <a href="http://jessezhuang.github.io/categories/programming-language"
                title="programming-language">
                programming-language<sup>1</sup></a>
            
              <a href="http://jessezhuang.github.io/categories/tutorial"
                title="tutorial">
                tutorial<sup>8</sup></a>
            
        </span>
        

        
        <hr>
        <span class="section">Tags</span>
        <span class="tags">
            
              <a href="http://jessezhuang.github.io/tags/blog">[blog]</a>
            
              <a href="http://jessezhuang.github.io/tags/cheatsheet">[cheatsheet]</a>
            
              <a href="http://jessezhuang.github.io/tags/database">[database]</a>
            
              <a href="http://jessezhuang.github.io/tags/devops">[devops]</a>
            
              <a href="http://jessezhuang.github.io/tags/docker">[docker]</a>
            
              <a href="http://jessezhuang.github.io/tags/git">[git]</a>
            
              <a href="http://jessezhuang.github.io/tags/golang">[golang]</a>
            
              <a href="http://jessezhuang.github.io/tags/hugo">[hugo]</a>
            
              <a href="http://jessezhuang.github.io/tags/internet">[internet]</a>
            
              <a href="http://jessezhuang.github.io/tags/java">[java]</a>
            
              <a href="http://jessezhuang.github.io/tags/linux">[linux]</a>
            
              <a href="http://jessezhuang.github.io/tags/mac">[mac]</a>
            
              <a href="http://jessezhuang.github.io/tags/mongodb">[mongodb]</a>
            
              <a href="http://jessezhuang.github.io/tags/nosql">[nosql]</a>
            
              <a href="http://jessezhuang.github.io/tags/python">[python]</a>
            
              <a href="http://jessezhuang.github.io/tags/string">[string]</a>
            
              <a href="http://jessezhuang.github.io/tags/ubuntu">[ubuntu]</a>
            
              <a href="http://jessezhuang.github.io/tags/vim">[vim]</a>
            
        </span>
        

        
        <hr>
        <span class="section">The author</span>

        <ul>
          
          <li>
            <a href="https://twitter.com/zhzexi" target="_blank" title="@zhzexi on Twitter">
              @zhzexi on Twitter
            </a>
          </li>
          

          
          <li>
            <a href="https://github.com/jessezhuang" target="_blank" title="@jessezhuang on GitHub">
              @jessezhuang on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="https://www.linkedin.com/in/zexizhuang" target="_blank" title="@zexizhuang on LinkedIn">
              @zexizhuang on LinkedIn
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>MongoDB Tutorial 5 - Aggregation Framework </h1>
			
			<div>
				Sun, Jun 26, 2016
				
					Last Modified: Jun 29, 2016
				
				<br>
				
				
				
				  
				  Category: <a href="http://jessezhuang.github.io/categories/tutorial">tutorial</a>
				  
				
				

				
				
					Tags:
					
					  <a href="http://jessezhuang.github.io/tags/mongodb">[mongodb]</a>
				  
					  <a href="http://jessezhuang.github.io/tags/nosql">[NoSQL]</a>
				  
					  <a href="http://jessezhuang.github.io/tags/database">[database]</a>
				  
					  <a href="http://jessezhuang.github.io/tags/python">[python]</a>
				  
					  <a href="http://jessezhuang.github.io/tags/java">[java]</a>
				  
				
				


			</div>

      
      <div id="toc">
        <h2>Table of Contents</h2>
        <nav id="TableOfContents">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#aggregation-pipeline">Aggregation Pipeline</a>
<ul>
<li><a href="#more-operators-with-examples-i-class-fa-fa-arrow-up-aria-hidden-true-i">More Operators with Examples <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></a></li>
<li><a href="#more-advanced-aggregation-examples">More Advanced Aggregation Examples</a>
<ul>
<li><a href="#double-grouping-i-class-fa-fa-arrow-up-aria-hidden-true-i">Double Grouping <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></a></li>
<li><a href="#double-unwind">Double <code>$unwind</code></a></li>
<li><a href="#full-text-search-and-aggregation-i-class-fa-fa-arrow-up-aria-hidden-true-i">Full Text Search and Aggregation <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></a></li>
<li><a href="#aggregation-with-java-driver">Aggregation with Java driver</a></li>
</ul></li>
<li><a href="#aggregation-options">Aggregation Options</a></li>
</ul></li>
<li><a href="#limitations-of-aggregation-framework">Limitations of Aggregation framework</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</nav>
      </div>

			

<p>The aggregation framework has its roots in SQL&rsquo;s world of <code>groupby</code> clause.</p>

<h1 id="introduction">Introduction</h1>

<p>Example used: imagine a SQL table of products.</p>

<table>
<thead>
<tr>
<th>name</th>
<th>category</th>
<th>manufacture</th>
<th>price</th>
</tr>
</thead>

<tbody>
<tr>
<td>ipad</td>
<td>tablet</td>
<td>Apple</td>
<td>499</td>
</tr>

<tr>
<td>nexus s</td>
<td>cellphone</td>
<td>Samsung</td>
<td>350</td>
</tr>
</tbody>
</table>

<p>To get number of products from each manufacture with SQL,</p>

<pre><code class="language-sql">select manufacture, count(*) from products
  group by manufacture;
</code></pre>

<p>with mongodb,</p>

<pre><code class="language-javascript">&gt; use agg
&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:&quot;$manufacturer&quot;, // creating new collection
      num_products:{$sum:1}
    } // a series of upserts
  }
])
{&quot;_id&quot; : &quot;Amazon&quot;, &quot;num_products&quot; : 2}
{&quot;_id&quot; : &quot;Sony&quot;, &quot;num_products&quot; : 1}
</code></pre>

<p>To do compound grouping with SQL,</p>

<pre><code class="language-sql">select manufacturer, category, count(*) from
  products group by manufacturer, category
</code></pre>

<p>with mongodb,</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([
  {$group:
    {
      // _id can be a complex document, just have to be unique
      _id:{&quot;manufacturer&quot;:&quot;$manufacturer&quot;,&quot;category&quot;:&quot;category&quot;},
      num_products:{$sum:1}
    }
  }
])
{&quot;_id&quot; : {&quot;manufacturer&quot;:&quot;Amazon&quot;, &quot;category&quot;:&quot;Tablets&quot;}, &quot;num_products&quot; : 2}
</code></pre>

<p>
<a target="_blank" href="https://docs.mongodb.com/manual/reference/sql-aggregation-comparison/">SQL to Aggregation Mapping Chart</a> <i class="fa fa-external-link"></i>
.</p>

<p>One can group on <code>_id:null</code> to aggregate every single document such as counting or summing.</p>

<h1 id="aggregation-pipeline">Aggregation Pipeline</h1>

<p><img src="http://jessezhuang.github.io/img/mongodb-aggregation-pipeline.png" alt="mongodb-aggregation-pipeline" /></p>

<table>
<thead>
<tr>
<th>pipeline stages</th>
<th>job</th>
<th>documents handling</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>$project</code></td>
<td>reshape documents, select out fields potentially deep in hierarchy</td>
<td>1:1</td>
</tr>

<tr>
<td><code>$match</code></td>
<td>filter out</td>
<td>n:1</td>
</tr>

<tr>
<td><code>$group</code></td>
<td>aggregate</td>
<td>n:1</td>
</tr>

<tr>
<td><code>$sort</code></td>
<td>sorting</td>
<td>1:1</td>
</tr>

<tr>
<td><code>$skip</code></td>
<td>skips</td>
<td>n:1</td>
</tr>

<tr>
<td><code>$limit</code></td>
<td>limit</td>
<td>n:1</td>
</tr>

<tr>
<td><code>$unwind</code></td>
<td>normalize, flatten data before grouping</td>
<td>1:n</td>
</tr>

<tr>
<td><code>$out</code></td>
<td>redirect output</td>
<td>1:1</td>
</tr>

<tr>
<td><code>$redact</code></td>
<td>security related</td>
<td>-</td>
</tr>

<tr>
<td><code>$geonear</code></td>
<td>location based searching</td>
<td>n:1</td>
</tr>
</tbody>
</table>

<p><code>$unwind</code> example: <code>tags:[red, blue]</code> unwinds to <code>tag:red</code> and <code>tag:blue</code>, expanding the number of documents.</p>

<h2 id="more-operators-with-examples-i-class-fa-fa-arrow-up-aria-hidden-true-i">More Operators with Examples <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></h2>

<p>The <code>$sum</code> operator:</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:{&quot;maker&quot;:&quot;$manufacturer&quot;}, // creating new collection
      sum_prices:{$sum:&quot;$price&quot;}
    } // a series of upserts
  }
])
{&quot;_id&quot; : {&quot;maker&quot;:&quot;Amazon&quot;}, &quot;sum_prices&quot; : 328}
</code></pre>

<p>The <code>$avg</code> operator:</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:{&quot;category&quot;:&quot;$category&quot;}, // creating new collection
      avg_prices:{$avg:&quot;$price&quot;}
    } // a series of upserts
  }
])
{&quot;_id&quot; : {&quot;category&quot;:&quot;Tablets&quot;}, &quot;avg_prices&quot; : 396.42714}
</code></pre>

<p>The <code>$addToSet</code> operator without counterpart in SQL:</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:{&quot;maker&quot;:&quot;$manufacturer&quot;}, // creating new collection
      categories:{$addToSet:&quot;$category&quot;}
    } // a series of upserts
  }
])
{&quot;_id&quot; : {&quot;maker&quot;:&quot;Apple&quot;}, &quot;categories&quot; : [&quot;Laptops&quot;, &quot;Tablets&quot;]}
</code></pre>

<p>The <code>$push</code> operator:</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:{&quot;maker&quot;:&quot;$manufacturer&quot;}, // creating new collection
      categories:{$push:&quot;$category&quot;}
    } // a series of upserts
  }
])
{&quot;_id&quot; : {&quot;maker&quot;:&quot;Apple&quot;}, &quot;categories&quot; :
  [&quot;Tablets&quot;, &quot;Tablets&quot;, &quot;Tablets&quot;, &quot;Laptops&quot;]}
</code></pre>

<p>The <code>$max</code> and <code>$min</code> operators:</p>

<pre><code class="language-javascript">&gt; db.products.aggregate([ // array
  {$group:
    {
      _id:{&quot;maker&quot;:&quot;$manufacturer&quot;}, // creating new collection
      maxprice:{$max:&quot;$price&quot;}
    } // a series of upserts
  }
])
{&quot;_id&quot; : {&quot;maker&quot;:&quot;Apple&quot;}, &quot;maxprice&quot; : 699 }
</code></pre>

<p>The <code>$project</code> phase/stage: you can remove, add, reshape keys, use simple functions on keys such as <code>$toUpper</code>, <code>$toLower</code>, <code>$add</code>, <code>$multiply</code>.</p>

<pre><code class="language-javascript">db.products.aggregate([
  {$project:
    {
      _id:0,
      'maker': {$toLower:&quot;$manufacturer&quot;},
      'details': {'category': &quot;$category&quot;,
        'price' : {&quot;$multiply&quot;:[&quot;$price&quot;,10]}
      },
      'item':'$name'
    }
  }
])
{&quot;maker&quot;:&quot;amazon&quot;, &quot;details&quot;:{&quot;category&quot;:&quot;Tablets&quot;, &quot;price&quot;:1990},
  &quot;item&quot;:&quot;Kindle Fire&quot;}
</code></pre>

<p>The <code>$match</code> phase. One thing to note about $match (and $sort) is that 
<a target="_blank" href="http://docs.mongodb.org/manual/core/aggregation-pipeline/?_ga=1.241498631.463502008.1466893758">they can use indexes</a> <i class="fa fa-external-link"></i>
, but only if done at the beginning of the aggregation pipeline. 
<a target="_blank" href="https://docs.mongodb.com/manual/tutorial/aggregation-zip-code-data-set/">Example zips collection.</a> <i class="fa fa-external-link"></i>
</p>

<pre><code class="language-javascript">db.zips.aggregate([
  {$match:
    {
      state:&quot;NY&quot;
    }
  },
  {$group:
    {
      _id: &quot;$city&quot;,
      population: {$sum:&quot;$pop&quot;},
      zip_codes: {$addToSet: &quot;$_id&quot;}
    }
  },
  {$project:
    {
      _id: 0,
      city: &quot;$_id&quot;,
      population: 1,
      zip_codes:1
    }
  },
  {$sort:
    {population:-1}
  },
  {$skip:10},
  {$limit:5}
])
{&quot;population&quot;:9743, &quot;zip_codes&quot;:[96162, 96161], &quot;city&quot;:&quot;TRUCKEE&quot;}
// order of fields not retained
</code></pre>

<p><code>$sort</code> operator. The aggregation framework supports both memory (default, 100 MB limit for each pipeline stage unless allowing disk) and disk based sorting. Sorting can be done before or after the grouping stage.</p>

<p><code>$skip</code> and <code>$limit</code> works similarly in <code>find()</code>.</p>

<p><code>$unwind</code> operator: it&rsquo;s not easy to group on the array elements (prejoined data) so we need to flatten (unjoin, data explosion) the array.</p>

<p>To count how many posts were attached to each tag in the blog,</p>

<pre><code class="language-javascript">use blog;
db.posts.aggregate([
    /* unwind by tags */
  {&quot;$unwind&quot;:&quot;$tags&quot;},
    /* now group by tags, counting each tag */
  {&quot;$group&quot;:
    {&quot;_id&quot;:&quot;$tags&quot;,
    &quot;count&quot;:{$sum:1}
    }
  },
  /* sort by popularity */
  {&quot;$sort&quot;:{&quot;count&quot;:-1}},
  /* show me the top 10 */
  {&quot;$limit&quot;: 10},
  /* change the name of _id to be tag */
  {&quot;$project&quot;:
    {_id:0,
      'tag':'$_id',
      'count' : 1
    }
  }
])
</code></pre>

<div class="admonition note">
<p class="admonition-title">To reverse $unwind</p>
<p>You can use $push to reverse the effects of an $unwind. If the array elements were unique, $addToSet will also do the job.</p>
</div>

<h2 id="more-advanced-aggregation-examples">More Advanced Aggregation Examples</h2>

<h3 id="double-grouping-i-class-fa-fa-arrow-up-aria-hidden-true-i">Double Grouping <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></h3>

<p>For a collection of student grades like below:</p>

<pre><code class="language-json">{ &quot;_id&quot; : { &quot;$oid&quot; : &quot;50b59cd75bed76f46522c34e&quot; },
  &quot;student_id&quot; : 0, &quot;class_id&quot; : 2,
  &quot;scores&quot; : [ { &quot;type&quot; : &quot;exam&quot;, &quot;score&quot; : 57.92947112575566 },
    { &quot;type&quot; : &quot;quiz&quot;, &quot;score&quot; : 21.24542588206755 },
    { &quot;type&quot; : &quot;homework&quot;, &quot;score&quot; : 68.19567810587429 },
    { &quot;type&quot; : &quot;homework&quot;, &quot;score&quot; : 67.95019716560351 },
    { &quot;type&quot; : &quot;homework&quot;, &quot;score&quot; : 18.81037253352722 }]
}
</code></pre>

<p>We want to figure out the average class grade for each class,</p>

<pre><code class="language-javascript">db.grades.aggregate([
    {'$group':{_id:{class_id:&quot;$class_id&quot;, student_id:&quot;$student_id&quot;},
      'average':{&quot;$avg&quot;:&quot;$score&quot;}}
    }, // pipe to a secondary grouping stage
    {'$group':{_id:&quot;$_id.class_id&quot;, 'average':{&quot;$avg&quot;:&quot;$average&quot;}}}
])
</code></pre>

<p><code>$first</code> and <code>$last</code>, example: find city with largest population in each state.</p>

<pre><code class="language-javascript">b.zips.aggregate([
  /* get the population of every city in every state */
  {$group:
    {
      _id: {state:&quot;$state&quot;, city:&quot;$city&quot;},
      population: {$sum:&quot;$pop&quot;},
    }
  },
  /* sort by state, population */
  {$sort:
    {&quot;_id.state&quot;:1, &quot;population&quot;:-1}
  },
  /* group by state, get the first item in each group */
  {$group:
    {
      _id:&quot;$_id.state&quot;,
      city: {$first: &quot;$_id.city&quot;},
      population: {$first:&quot;$population&quot;}
    }
  },
  /* now sort by state again */
  {$sort:
   {&quot;_id&quot;:1}
  }
])
</code></pre>

<p><code>$out</code> redirects the output to a new collection, write over, no appending, considering a games collection with documents structured like,</p>

<pre><code class="language-sh">{
  &quot;_id&quot;:ObjectId(&quot;53684890&quot;),
  first_name: &quot;Jerzy&quot;,
  last_name: &quot;Fischer&quot;,
  points: 3,
  moves: [1,2,5]
}
</code></pre>

<p>To summarize each person&rsquo;s points,</p>

<pre><code class="language-javascript">db.games.aggregate([
  {$group:
    {_id:{first_name:&quot;$first_name&quot;, last_name:&quot;$last_name&quot;},
    points:{$sum:&quot;$points&quot;}
    }
  },
  {$out:&quot;summary_results&quot;}
])
</code></pre>

<p>Note that the <code>_id</code> field of the redirected output must be unique, the operations below will not succeed and leave the <code>summary_results</code> collection untouched.</p>

<pre><code class="language-javascript">db.games.aggregate([
  {$unwind:&quot;moves&quot;},
  {$out:&quot;summary_results&quot;}
])
</code></pre>

<h3 id="double-unwind">Double <code>$unwind</code></h3>

<p>Create a Cartesian product of the two or more arrays.</p>

<pre><code class="language-javascript">db.inventory.aggregate([
  {$unwind: &quot;$sizes&quot;},
  {$unwind: &quot;$colors&quot;},
  {$group:
    {
      '_id': {'size':'$sizes', 'color':'$colors'},
      'count' : {'$sum':1}
    }
  }
])
</code></pre>

<p>To reverse with <code>$addToSet</code> in one stage since array elements were unique,</p>

<pre><code class="language-javascript">db.inventory.aggregate([
  {$unwind: &quot;$sizes&quot;},
  {$unwind: &quot;$colors&quot;},
  {$group:
    {
      '_id': &quot;$name&quot;,
      'sizes': {$addToSet: &quot;$sizes&quot;},
      'colors': {$addToSet: &quot;$colors&quot;},
    }
  }
])
</code></pre>

<p>To reverse with <code>$push</code>,</p>

<pre><code class="language-javascript">db.inventory.aggregate([
  {$unwind: &quot;$sizes&quot;},
  {$unwind: &quot;$colors&quot;},
  /* create the color array */
  {$group:
    {
      '_id': {name:&quot;$name&quot;,size:&quot;$sizes&quot;},
      'colors': {$push: &quot;$colors&quot;},
    }
  },
  /* create the size array */
  {$group:
    {
      '_id': {'name':&quot;$_id.name&quot;,
      'colors' : &quot;$colors&quot;},
      'sizes': {$push: &quot;$_id.size&quot;}
    }
  },
  /* reshape for beauty */
  {$project:
    {
      _id:0,
      &quot;name&quot;:&quot;$_id.name&quot;,
      &quot;sizes&quot;:1,
      &quot;colors&quot;: &quot;$_id.colors&quot;
    }
  }
])
</code></pre>

<h3 id="full-text-search-and-aggregation-i-class-fa-fa-arrow-up-aria-hidden-true-i">Full Text Search and Aggregation <a href="#"><i class="fa fa-arrow-up" aria-hidden="true"></i></a></h3>

<p>&ldquo;Two great taste that go great together.&rdquo; - <a href="https://twitter.com/erlichson?lang=en">Andrew Erlichson</a>.</p>

<pre><code class="language-javascript">db.sentences.aggregate([
  {$match:{$text:{$search:&quot;tree rat&quot;}}},// must appear first
  // one full text search per collection, no need to specify
  {$sort:{score:{$meta:&quot;textScore&quot;}}},
  {$project:{words:1, _id:0}}
])
{&quot;words&quot;:&quot;rat shrub granite.&quot;}
</code></pre>

<p><code>$text</code> is only allowed in the $match stage of the aggregation pipeline and must be the first stage of the aggregation pipeline.</p>

<h3 id="aggregation-with-java-driver">Aggregation with Java driver</h3>

<pre><code class="language-java">public class ZipCodeAggregationTest {
  public static void main (Strng[] args) {
    MongoClient client = new MongoClient();
    MongoDatabase database = client.getDatabase(&quot;course&quot;);
    MongoCollection&lt;Document&gt; collection = database.getCollection(&quot;zipcodes&quot;);

    // verbose
    // List&lt;Document&gt; pipeline = Arrays.asList(new Document(&quot;$group&quot;,
    //   new Document(&quot;_id&quot;, &quot;$state&quot;).append(&quot;totalPop&quot;, new Document(
    //     &quot;$sum&quot;, &quot;$pop&quot;))), new Document(&quot;$match&quot;, new Document(&quot;totalPop&quot;,
    //       new Document(&quot;$gte&quot;, 10000000))));

    List&lt;Bson&gt; pipeline = Arrays.asList(Aggregates.group(&quot;$state&quot;, Accumulators.sum(&quot;totalPop&quot;,
      &quot;$pop&quot;)), Aggregates.match(gte(&quot;totalPop&quot;, 10000000)));

    List&lt;Document&gt; pipeline2 = Arrays.asList(Document.parse(
      &quot;{ $group: { _id: \&quot;$state\&quot;, totalPop: { $sum: \&quot;$pop\&quot; } } }&quot;),
      Document.parse(&quot;{ $match: { totalPop: { $gte: 1010001000 } } }&quot;));

    List&lt;Document&gt; results = collection.aggregate(pipeline).
      into(new ArrayList&lt;Document&gt;());
    // List&lt;Document&gt; results = collection.find().into(new ArrayList&lt;Document&gt;());

    for (Document cur : results) {
      System.out.println(cur.toJson());
    }
  }
}
</code></pre>

<h2 id="aggregation-options">Aggregation Options</h2>

<ul>
<li><code>explain</code> gets the query plan if we ran it, useful in optimization.</li>
<li><code>allowDiskUse</code> allows use of hard drive for intermediate stages. Any stage is limited to 100 MB of memory use and will fail if exceeded. Certain stages like projection run the documents through and don&rsquo;t use a lot of memory.</li>
<li><code>cursor</code> allows cursor use and specify cursor size.</li>
</ul>

<pre><code class="language-javascript">use agg
db.zips.aggregate(
  [{$group:{_id:&quot;$state&quot;, population:{$sum:&quot;$pop&quot;}}}],
  {explain:true},
  {allowDiskUse:true}
)
</code></pre>

<p>Two forms of aggregation:</p>

<ul>
<li><code>aggregate([stage1, stage2, ...])</code></li>
<li><code>aggregate(stage1, stage2, ...)</code> cannot add options</li>
</ul>

<p>Prior to the release of the 3.0 pymongo driver, you would get a document for aggregation queries by default (the aggregation result is limited by the 16 Mb size), though you had the option of getting back a cursor if you were working with MongoDB 2.6.0+, and your pymongo version was 2.6.0+. Starting with the release of the 3.0 pymongo driver, however the aggregation pipeline queries using the driver will now return a cursor by default.</p>

<p>The mongo shell returns a cursor by default starting 2.6.0.</p>

<pre><code class="language-python">import pymongo
connection = pymongo.MongoClient()
db = connection.agg

result = db.zips.aggregate([{'$group':{'_id':'state',
  'population':{'$sum':'$pop'}}}])

print result
# &lt;pymongo.command_cursor.CommandCursor object at 0x7f62829f5210&gt; in 3.2.6

# piror to 3.0
result = db.zips.aggregate([{'$group':{'_id':'state',
    'population':{'$sum':'$pop'}}}], cursor={}, allowDiskUse=True)

for doc in result:
    print doc
</code></pre>

<pre><code class="language-sh"># prior to 3.0
{u'ok':1.0, u'result' : [array of resulted documents]}
</code></pre>

<h1 id="limitations-of-aggregation-framework">Limitations of Aggregation framework</h1>

<ul>
<li>100 MB limit for pipeline stages, <code>allowDiskUse</code> to get around.</li>
<li>16 MB limit if you decide to return the result as a single document, set <code>cursor</code>.</li>
<li>In a sharded system, stages like <code>$group</code>, <code>$sort</code> will bring back the results to the first shard. Stages like <code>$match</code> and <code>$project</code> can go in parallel. Aggregation in mongodb is an interface to map/reduce jobs. Alternatively, get the data out of mongodb using the hadoop connector and use Hadoop map/reduce. There is a map/reduce functionality built into mongodb that is not recommended.</li>
</ul>

<p><img src="http://jessezhuang.github.io/img/mongodb-limitation.png" alt="mongodb sharded system limitation" /></p>

<h1 id="resources">Resources</h1>

<ol>
<li>
<a target="_blank" href="https://university.mongodb.com/courses/M101P/about">MongoDB University Classes</a> <i class="fa fa-external-link"></i>
</li>
<li>
<a target="_blank" href="https://docs.mongodb.com/">MongoDB Docs</a> <i class="fa fa-external-link"></i>
</li>
</ol>

<p><a href="#">go to top <i class="fa fa-arrow-up" aria-hidden="true"></i></a></p>

<p><a href="http://jessezhuang.github.io/
tags/mongodb/">Link to the MongoDB tutorial series.</a></p>


			<aside class="copyright" role="note">
  
  &copy; 2017 Zexi Zhuang &ndash;
  
  built with
  <a href="https://www.gohugo.io" target="_blank">Hugo</a>
  using a customized
  <a href="https://github.com/JesseZhuang/hugo-material-blog" target="_blank">
    Material
  </a> theme.
</aside>


		  <div id="disqus_thread"></div>
<script type="text/javascript">

  (function() {
      
      
      
      

      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      var disqus_shortname = 'codingcombinotorics';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="http://jessezhuang.github.io/article/mongodb-intro/" title="Mongodb Tutorial 1 - Introduction">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Mongodb Tutorial 1 - Introduction
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="http://jessezhuang.github.io/article/ubuntu/" title="Ubuntu Tips and Tricks">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Ubuntu Tips and Tricks
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'http:\/\/jessezhuang.github.io\/';
      var repo_id  = 'JesseZhuang\/hugo-material-blog';
    
    </script>

    <script src="http://jessezhuang.github.io/javascripts/application.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/highlight.min.js"></script>
    

    

    
      <script>
        (function(i,s,o,g,r,a,m){
          i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||
          []).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
          m.parentNode.insertBefore(a,m)
        })(window, document,
          'script', '//www.google-analytics.com/analytics.js', 'ga');
         
        ga('create', 'UA-79594714-1', 'auto');
        ga('set', 'anonymizeIp', true);
        ga('send', 'pageview');
         
        var buttons = document.querySelectorAll('a');
        Array.prototype.map.call(buttons, function(item) {
          if (item.host != document.location.host) {
            item.addEventListener('click', function() {
              var action = item.getAttribute('data-action') || 'follow';
              ga('send', 'event', 'outbound', action, item.href);
            });
          }
        });
         
        var query = document.querySelector('.query');
        query.addEventListener('blur', function() {
          if (this.value) {
            var path = document.location.pathname;
            ga('send', 'pageview', path + '?q=' + this.value);
          }
        });
      </script>
    

    
    <script>hljs.initHighlightingOnLoad();</script>

  </body>
</html>

